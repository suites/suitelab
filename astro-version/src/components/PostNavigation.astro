---
import { getCollection } from 'astro:content';
import { twemojiParse } from '@/utils/twemoji.util';
import { formatDate } from '@/utils/date';

// í˜„ì¬ í¬ìŠ¤íŠ¸ì˜ ìŠ¬ëŸ¬ê·¸ ê°€ì ¸ì˜¤ê¸°
const currentSlug = Astro.url.pathname.split('/').pop() || '';

// ëª¨ë“  í¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (ë‚ ì§œìˆœ ì •ë ¬)
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => {
  const dateA = ('date' in a.data ? a.data.date : null) || a.data.pubDate || new Date(0);
  const dateB = ('date' in b.data ? b.data.date : null) || b.data.pubDate || new Date(0);
  return new Date(dateB).getTime() - new Date(dateA).getTime();
});

// í˜„ì¬ í¬ìŠ¤íŠ¸ì˜ ì¸ë±ìŠ¤ ì°¾ê¸° (slug ë§¤ì¹­ ë¡œì§ ê°œì„ )
const currentIndex = sortedPosts.findIndex(post => {
  const postSlug = ('slug' in post.data ? post.data.slug : null) || post.id.replace(/\/index\.mdx?$/, '').replace(/\//g, '-');
  return postSlug === currentSlug;
});

// ì´ì „/ë‹¤ìŒ í¬ìŠ¤íŠ¸ ì°¾ê¸°
const prevPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const nextPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;


// ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° í—¬í¼
function getPostDate(post: typeof prevPost): Date {
  if (!post) return new Date();
  const date = ('date' in post.data ? post.data.date : null) || post.data.pubDate || new Date();
  return date instanceof Date ? date : new Date(date);
}

// ë‚ ì§œ í¬ë§·íŒ… í—¬í¼
function getFormattedDate(post: typeof prevPost): string {
  if (!post) return '';
  return formatDate(getPostDate(post), 'YYYY.MM.DD');
}

// ì´ëª¨ì§€ íŒŒì‹± í—¬í¼
function getParsedEmoji(post: typeof prevPost): string {
  if (!post) return '';
  const emoji = ('emoji' in post.data ? post.data.emoji : null) || 'ğŸ˜º';
  return twemojiParse(emoji);
}
---

{(prevPost || nextPost) && (
  <nav class="post-navigation" aria-label="í¬ìŠ¤íŠ¸ ë„¤ë¹„ê²Œì´ì…˜">
    {prevPost && (
      <div class="post-card-wrapper">
        <a href={`/${('slug' in prevPost.data ? prevPost.data.slug : null) || prevPost.id.replace(/\/index\.mdx?$/, '').replace(/\//g, '-')}`} class="post-card-link">
          <div class="post-card-emoji" role="img" aria-hidden="true" set:html={getParsedEmoji(prevPost)}></div>
          <div class="post-card-content">
            <h5 class="post-card-title">{prevPost.data.title}</h5>
            <time class="post-card-date" datetime={getPostDate(prevPost).toISOString()}>
              {getFormattedDate(prevPost)}
            </time>
          </div>
        </a>
      </div>
    )}
    
    {nextPost && (
      <div class="post-card-wrapper">
        <a href={`/${('slug' in nextPost.data ? nextPost.data.slug : null) || nextPost.id.replace(/\/index\.mdx?$/, '').replace(/\//g, '-')}`} class="post-card-link">
          <div class="post-card-emoji" role="img" aria-hidden="true" set:html={getParsedEmoji(nextPost)}></div>
          <div class="post-card-content">
            <h5 class="post-card-title">{nextPost.data.title}</h5>
            <time class="post-card-date" datetime={getPostDate(nextPost).toISOString()}>
              {getFormattedDate(nextPost)}
            </time>
          </div>
        </a>
      </div>
    )}
  </nav>
)}

<style>
  /* Wrapper - RelatedPostsì™€ ë™ì¼ */
  .post-navigation {
    margin-top: 0;
    background: #f1f4f7; /* whitesmoke - RelatedPostsì™€ ë™ì¼í•œ ë°°ê²½ìƒ‰ */
    padding: 2em 2.5em; /* RelatedPostsì™€ ë™ì¼í•œ íŒ¨ë”© */
    border-top: none;
  }
  
  @media (max-width: 500px) {
    .post-navigation {
      padding: 30px 20px; /* RelatedPostsì™€ ë™ì¼í•œ ëª¨ë°”ì¼ íŒ¨ë”© */
    }
  }
  
  /* PostCardWrapper - RelatedPostsì™€ ë™ì¼ */
  .post-card-wrapper {
    margin-bottom: 1em;
  }
  
  .post-card-wrapper:last-child {
    margin-bottom: 0;
  }
  
  /* post-card-link - RelatedPostsì™€ ë™ì¼ */
  .post-card-link {
    display: flex;
    align-items: center;
    padding: 15px;
    background: #fff;
    border-radius: 5px;
    color: #313746; /* theme.colors.blackLight */
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    text-decoration: none;
    transition: background 0.2s ease;
  }
  
  .post-card-link:hover {
    background: #e0ebf1;
  }
  
  @media (max-width: 500px) {
    .post-card-link {
      padding: 10px;
    }
  }
  
  /* PostCardEmoji - RelatedPostsì™€ ë™ì¼ */
  .post-card-emoji {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
    width: 80px;
    height: 80px;
    background: #f1f4f7; /* theme.colors.whitesmoke */
    border-radius: 4px;
    font-size: 50px;
    flex-shrink: 0;
  }
  
  .post-card-emoji :global(img) {
    width: 55px;
    height: 55px;
  }
  
  /* PostCardContent - RelatedPostsì™€ ë™ì¼ */
  .post-card-content {
    width: calc(100% - 80px);
    padding-left: 15px;
  }
  
  .post-card-title {
    font-size: 1.1em;
    font-weight: 700;
    line-height: 1.45;
    margin: 0 0 0.1em 0;
    color: #313746; /* theme.colors.blackLight */
  }
  
  .post-card-date {
    display: block;
    margin-bottom: 0.1em;
    letter-spacing: 0.05em;
    font-size: 0.8em;
    color: #969fa7; /* theme.colors.silver */
  }
  
  @media (max-width: 500px) {
    .post-card-content {
      padding-left: 15px;
    }
    
    .post-card-title {
      font-size: 1em;
    }
  }
</style>